<!DOCTYPE html>
<html>
<!-- TODO 
improve summary with option values instead of keys
-->

<head><meta charset="utf-8"/>
<style type="text/css">
/* span.NL and span.EN must be the AT THE TOP */
span.NL { display: none }
span.EN { display: inline }
/* the rest can be in any position */
body { background: #ddd; margin: 0; padding: 0; width: 100%; height: 100%; }
div#page { max-width: 1146px; margin: 0em auto; border-left: 1px solid #aaa; border-right: 1px solid #aaa; background: #fff; min-height: 101%; }
div#main { padding: 1% }
td { border-left: 2px; padding: 0ex 1ex; white-space: nowrap;  }
table.list { border-collapse: collapse }
table.list td { border-top: 1px solid #888 }
table.list tr:hover { background: #4F8 }
div.list { border: 2px solid blue; margin: 1ex 0ex; padding: 1ex; margin-bottom: 0px; border-radius: 1ex }
table.add { border: 1px solid blue; background: #f0faff; margin: 1ex; padding: 1ex; margin-top: 0px; padding-top:0px}
div.error { background: #fff; color: #800; font-weight: bold; display: block }
div.id { text-align: center; background: #eee; padding: 1ex; border-radius: 1ex; border: 1px solid black}
</style>
<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript">
"use strict"

var DATA = {}

var FORMS = {
  rider: {
    firstName: { name: { NL: "Voornaam", EN: "First name" }, type: "text", check: checkName },
    lastName: { name: { NL: "Achternaam", EN: "Last name" }, type: "text", check: checkName },
    gender: { name: { NL: "Geslacht", EN: "Gender" }, type: "radio", check: checkRadio, options: genderOptions },
    city: { name: { NL: "Woonplaats", EN: "Place of residence" }, type: "text", check: checkName },
    country: { name: { NL: "Land", EN: "Country" }, type: "text", check: checkName },
    birthDate: { name: { NL: "Geboortedatum", EN: "Date of birth" }, type: "date", check: checkBirth },
    email: { name: { NL: "Email adres", EN: "Email address" }, type: "text", check: checkEmail, default: '' },
    nickname: { name: { NL: "Bijnaam", EN: "Nick name" }, type: "text", check: checkName, default: '' },
    ligfietsnet: { name: { NL: "Ligfiets.net ID", EN: "Ligfiets.net ID" }, type: "text", check: checkLigfietsnet, default: '' },
    about: { name: { NL: "Over jezelf (voor pers)", EN: "About yourself (for press)" }, type: "textarea", check: checkName, default: '' },
  },
  bike: {
    name: { name: { NL: "Koosnaam", EN: "Given name" }, type: "text", check: checkName, default: '' },
    standard: { name: { NL: "Fiets", EN: "Bike" }, type: "select", check: checkSelect, options: standardOptions },
    make: { name: { NL: "&nbsp;&nbsp;Merk en type", EN: "&nbsp;&nbsp;Make and type" }, type: "text", check: checkName, default: '', preset: makePreset },
    track: { name: { NL: "&nbsp;&nbsp;Aantal wielen", EN: "&nbsp;&nbsp;Number of wheels" }, type: "radio", check: checkRadio, options: trackOptions, preset: trackPreset },
    fairing: { name: { NL: "&nbsp;&nbsp;Stroomlijn", EN: "&nbsp;&nbsp;Fairing" }, type: "radio", check: checkRadio, options: fairingOptions, preset: fairingPreset },
    drive: { name: { NL: "&nbsp;&nbsp;Aandrijving", EN: "&nbsp;&nbsp;Drive" }, type: "select", check: checkSelect, options: driveOptions, preset: drivePreset },
    comment: { name: { NL: "Bijzonderheden", EN: "Peculiarities" }, type: "text", check: checkName, default: '' }
  },
  onehour: {
    _day: 1,
    rider: { name: { NL: "Rijder", EN: "Rider" }, type: "select", check: checkSelect, options: riderOptions },
    bike: { name: { NL: "Fiets", EN: "Bike" }, type: "select", check: checkSelect, options: bikeOptions },
  },
  indoor1lap: {
    _day: 1,
    rider: { name: { NL: "Rijder", EN: "Rider" }, type: "select", check: checkSelect, options: riderOptions },
    bike: { name: { NL: "Fiets", EN: "Bike" }, type: "select", check: checkSelect, options: bikeOptions },
  },
  singletrack: {
    _day: 1,
    rider: { name: { NL: "Rijder", EN: "Rider" }, type: "select", check: checkSelect, options: riderOptions },
    bike: { name: { NL: "Fiets", EN: "Bike" }, type: "select", check: checkSelect, options: bikeOptions },
  },
  multitrack: {
    _day: 1,
    rider: { name: { NL: "Rijder", EN: "Rider" }, type: "select", check: checkSelect, options: riderOptions },
    bike: { name: { NL: "Fiets", EN: "Bike" }, type: "select", check: checkSelect, options: bikeOptions },
  },
  outdoor1lap: {
    _day: 2,
    rider: { name: { NL: "Rijder", EN: "Rider" }, type: "select", check: checkSelect, options: riderOptions },
    bike: { name: { NL: "Fiets", EN: "Bike" }, type: "select", check: checkSelect, options: bikeOptions },
  },
  threehour: {
    _day: 2,
    rider: { name: { NL: "Rijder", EN: "Rider" }, type: "select", check: checkSelect, options: riderOptions },
    bike: { name: { NL: "Fiets", EN: "Bike" }, type: "select", check: checkSelect, options: bikeOptions },
    duration: { name: { NL: "Duur", EN: "Duration" }, type: "radio", check: checkRadio, options: durationOptions }
  },
  camping: {
    _simple_: true,
    adultFri: { name: { NL: "Volwassenen vrijdag/zaterdag", EN: "Adults Friday/Saturday" }, price: 4, type: "select", options: countOptions },
    childFri: { name: { NL: "Kinderen &lt;16 vrijdag/zaterdag", EN: "Children &lt;16 Friday/Saturday" }, price: 2, type: "select", options: countOptions },
    adultSat: { name: { NL: "Volwassenen zaterdag/zondag", EN: "Adults Saturday/Sunday" }, price: 4, type: "select", options: countOptions },
    childSat: { name: { NL: "Kinderen &lt;16 zaterdag/zondag", EN: "Children &lt;16 Saturday/Sunday" }, price: 2, type: "select", options: countOptions }
  },
  meal: {
    _simple_: true,
    mealFri: { name: { NL: "Chinese maaltijd vrijdagavond", EN: "Meal (Chinese) Friday evening" }, price: 10, type: "select", options: countOptions },
    mealPlan: { name: { NL: "Maaltijden Zaterdag/Zondag (2x ontbijt, 1x diner)", EN: "Meals Saturday/Sunday (2x breakfast, 1x dinner)" }, price: 27.50, type: "select", options: countOptions },
    breakfastSat: { name: { NL: "Ontbijt zaterdagochtend", EN: "Breakfast Saturday morning" }, price: 6.50, type: "select", options: countOptions },
    mealSat: { name: { NL: "Diner zaterdagavond", EN: "Dinner Saturday evening" }, price: 17.50, type: "select", options: countOptions },
    breakfastSun: { name: { NL: "Ontbijt zondagochtend", EN: "Breakfast Sunday morning" }, price: 6.50, type: "select", options: countOptions }
  }
}

var HIDDEN = {   
  race: {
    oneDay: { price: 15 },
    twoDays: { price: 25 }
  }
}

var LANG = {
  rider: {
    NL: ['rijder','rijders'],
    EN: ['rider','riders']
  },
  bike: {
    NL: ['fiets','fietsen'],
    EN: ['bike','bikes']
  },
  onehour: {
    NL: ['deelnemer','rijders+fietsen voor de 1-uurs race'],
    EN: ['entry','riders+bikes for the 1 hour race']
  },
  indoor1lap: {
    NL: ['deelnemer','rijders+fietsen voor de snelste ronde in het velodrome'],
    EN: ['entry','riders+bikes for the fastest lap indoor']
  },
  outdoor1lap: {
    NL: ['deelnemer','rijders+fietsen voor de snelste ronde op de buitenbaan'],
    EN: ['entry','riders+bikes for the fastest lap outdoor circuit']
  },
  singletrack: {
    NL: ['deelnemer','rijders+fietsen voor het tweewieler criterium'],
    EN: ['entry','riders+bikes for the single track race']
  },
  multitrack: {
    NL: ['deelnemer','rijders+fietsen voor het multi-track criterium'],
    EN: ['entry','riders+bikes for the multi track race']
  },
  threehour: {
    NL: ['deelnemer','rijders+fietsen voor de gecombineerde 3/6 uurs race'],
    EN: ['entry','riders+bikes for the combined 3/6 hour race']
  },
  camping: {
    NL: ['camping','camping'],
    EN: ['camping','camping']
  },
  meal: {
    NL: ['maaltijd','maaltijden'],
    EN: ['meal','meals']
  }
}

var FORM_ERROR = false

function initData() {
  try {
    DATA = JSON.parse(getCookie('DATA'))
  } catch(e) {
    DATA = {}
  }
  for (var k in FORMS) if (!DATA[k]) DATA[k] = {}
  summarize()
}

function initLanguage() {
  try {
    var on = JSON.parse(getCookie('LANG'))
  } catch(e) {
    on = 'EN'
  }
  selectLanguage(on)
}

/* field value validation functions */
function checkName(val,itemKey,id) {
  val = val.trim()
  var name = FORMS[itemKey][id].name.EN
  toggleError(itemKey+'-'+id,val && val.length>=2 ? '' : 'Error: enter a valid '+name+'.')
  return val
}

var checkLigfietsnet = checkName

function checkRadio(val,itemKey,id) {
  toggleError(itemKey+'-'+id,val !== undefined ? '' : 'Error: select a value.')
  return val
}

function checkSelect(val,itemKey,id) {
  toggleError(itemKey+'-'+id,val !== '_' ? '' : '<span class="EN">Error: select a value.</span><span class="NL">Fout: kies een waarde.</span>')
  return val
}

function checkEmail(val,itemKey,id) {
  var re = /^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;
  toggleError(itemKey+'-'+id,re.test(val) ? '' : '<span class="EN">Error: invalid email address.</span><span class="NL">Fout: ongeldig email adres.</span>')
  return val
}
  
function checkBirth(val,itemKey,id) {
  if (val) {
    var date = new Date(val)
    var year = date.getFullYear()
    toggleError(itemKey+'-'+id,year>1900 && year<2016 ? '' : '<span class="EN">Error: invalid year.</span><span class="NL">Fout: ongeldig jaar.</span>')
  } else {
    toggleError(itemKey+'-'+id,val ? '' : '<span class="EN">Error: enter a date.</span><span class="NL">Fout: vul een datum in.</span>')
  }
  return val
}

/* option generation functions */
function genderOptions() {
  return {
    male: {EN:'male',NL:'man'},
    female: {EN:'female',NL:'vrouw'}
  }
}

function standardOptions() {
  return {
    _: {EN:'Choose ...',NL:'Kies ...'},
    unfaired2: {EN:'Unfaired bike',NL:'Ongestroomlijnde tweewieler'},
    unfaired3: {EN:'Unfaired trike',NL:'Ongestroomlijnde trike'},
    tailfaired2: {EN:'Tailfaired bike',NL:'Tweewieler met staartpunt'},
    tailfaired3: {EN:'Tailfaired trike',NL:'Trike met staartpunt'},
    fullyfaired2: {EN:'Fully faired bicycle',NL:'Volledig gestroomlijnde tweeweler'},
    fullyfaired3: {EN:'Fully faired tricycle',NL:'Volledig gestroomlijnde trike'},
    quest: {EN:'Velomobiel.nl Quest',NL:'Velomobiel.nl Quest'},
    df: {EN:'InterCityBike DF',NL:'InterCityBike DF'},
    rowing: {EN:'Rowing bike',NL:'Roeifiets'},
    thys222: {EN:'Thys 222 rowing bike',NL:'Thys 222 roeifiets'},
    tandem: {EN:'Tandem',NL:'Tandem'},
    handbike: {EN:'Handbike',NL:'Handbike'},
    other: {EN:'Other ...',NL:'Anders ...'}
  }
}

function trackOptions() {
  return {
    single: {EN:'Two or less',NL:'Twee of minder'},
    multi: {EN:'Three or more',NL:'Drie of meer'}
  }
}

function fairingOptions() {
  return {
    full: {EN:'Fully faired',NL:'Gestroomlijnd'},
    front: {EN:'Front fairing',NL:'Alleen voorkant'},
    rear: {EN:'Tail fairing',NL:'Staartpunt'},
    none: {EN:'Unfaired',NL:'Ongestroomlijnd'}
  }
}

function driveOptions() {
  return {
    pedal: {EN:'Regular',NL:'Normaal'},
    rowing: {EN:'Rowing movement',NL:'Roeibeweging'},
    hand: {EN:'Hand drive',NL:'Handaabndrijving'},
    special: {EN:'Special',NL:'Speciaal'}
  }
}

function riderOptions() {
  var riders = DATA.rider
  var options = {}
  for (var k in riders) {
    var r = riders[k]
    if (r) {
      var name = r.firstName+' '+r.lastName
      options[k] = { NL:name,EN:name }
    }
  }
  if (!count(options)) options = { '_': {NL:'Maak eerst rijder aan',EN:'Define riders first'} }
  return options
}

function bikeOptions() {
  var bikes = DATA.bike
  var options = {}
  for (var k in bikes) {
    var r = bikes[k]
    var name = '"'+r.name+'" '+r.make
    options[k] = { NL:name,EN:name }
  }
  if (!count(options)) options = { '_': {NL:'Maak eerst fiets aan',EN:'Define bikes first'} }
  return options
}

function durationOptions() {
  return {
    '3':{EN: '3 hours', NL: '3 uur'},
    '6':{EN: '6 hours', NL: '6 uur'}
  }
}

function countOptions() {
  var options = {}
  for (var i=0; i<=10; i++) {
    var s = ''+i
    options[s] = {EN:s,NL:s}
  }
  return options
}

function makePreset(itemKey) {
  var ans = {
    thys222: 'Thys 222',
    quest: 'Velomobiel.nl Quest',
    df: 'InterCityBike DF'
  }
  return ans[fieldValue(itemKey,'standard')]
}

function trackPreset(itemKey) {
  var ans = {
    unfaired2: 'single',
    unfaired3: 'multi',
    tailfaired2: 'single',
    tailfaired3: 'multi',
    fullyfaired2: 'single',
    fullyfaired3: 'multi',
    quest: 'multi',
    df: 'multi',
    thys222: 'single'
  }
  return ans[fieldValue(itemKey,'standard')]
}

function fairingPreset(itemKey) {
  var ans = {
    unfaired2: 'none',
    unfaired3: 'none',
    tailfaired2: 'tail',
    tailfaired3: 'tail',
    fullyfaired2: 'full',
    fullyfaired3: 'full',
    quest: 'full',
    df: 'full'
  }
  return ans[fieldValue(itemKey,'standard')]
}

function drivePreset(itemKey) {
  var ans = {
    unfaired2: 'pedal',
    unfaired3: 'pedal',
    tailfaired2: 'pedal',
    tailfaired3: 'pedal',
    fullyfaired2: 'pedal',
    fullyfaired3: 'pedal',
    quest: 'pedal',
    df: 'pedal',
    rowing: 'pedal',
    thys222: 'rowing',
    tandem: 'pedal',
    handbike: 'hand'
  }
  return ans[fieldValue(itemKey,'standard')]
}

/* utility functions */
function setCookie(key,value) {
  document.cookie = key + "=" + value;
}
function getCookie(key) {
  var parts = decodeURIComponent(document.cookie).split(';');
  for(var i=0; i<parts.length; i++) {
    var c = parts[i].trim()
    if (c.indexOf(key+'=') == 0) {
      return c.substr(key.length+1);
    }
  }
  return "";
}
function getElem(id) { return document.getElementById(id) }
function next(h) { var n=0; for (var k in h) if (Number(k)>=n) n = Number(k)+1; return n }
function count(h) { var n=0; for (var k in h) if (h.hasOwnProperty(k)) n++; return n }

function getValue(field) {
  if (field.tagName.toLowerCase() == 'input') {
    if (field.type == 'text') return field.value
    if (field.type == 'textarea') return field.value
    if (field.type == 'date') return field.value
    if (field.type == 'radio') {
      var radios = document.getElementsByName(field.id);
      for (var i in radios) if (radios[i].checked) return radios[i].value
    }
  } else if (field.tagName.toLowerCase() == 'select') {
    return field.selectedIndex < 0 ? undefined : field.options[field.selectedIndex].value
  }
}

function setValue(field,value) {
  if (field.tagName.toLowerCase() == 'input') {
    if (field.type == 'text') field.value = value
    if (field.type == 'textarea') return field.value
    if (field.type == 'date') field.value = value
    if (field.type == 'radio') {
      var radios = document.getElementsByName(field.id);
      for (var i=0; i<radios.length; i++) {
        var r = radios[i]
        r.checked = (r.value == value ? true : false)
      }
    }
  } else if (field.tagName.toLowerCase() == 'select') {
    var options = field.options
    for (var i=0; i<options.length; i++) if (options[i].value == value) field.selectedIndex = i
  }
}

function setOptions(field,type,options) {
  if (type == 'select') {
    var val = getValue(field)
    // remove old options
    for (var k=field.options.length-1; k>=0; k--) field.remove(k)
    // add new options
    for (var k in options) {
      var o = options[k]
      var oElem = document.createElement('OPTION')
      oElem.value = k
      oElem.text = o.EN+(o.NL != o.EN ? ' / '+o.NL : '')
      if (k == val) oElem.selected = true
      if (k.charAt(0) == '_') oElem.disabled = true
      field.add(oElem,null)
    }
  }
}

function fieldValue(itemKey,k) {
  return getValue(getElem(itemKey+'-'+k))
}

/* initialization of forms and values */
function initForm(itemKey) {
  var a = []
  var fields = FORMS[itemKey]
  var complex = !fields._simple_
  a.push('<table class="add">')
  a.push('<tr>')
  if (complex) {
    var itemName = LANG[itemKey]
    var nameHtml = '<span class="EN">'+itemName.EN[0]+'</span><span class="NL">'+itemName.NL[0]+'</span>'
    a.push('<td rowspan="'+(2*count(fields)+2)+'" style="padding-right:2ex"><div class="id">'+nameHtml+'<br><select id="'+itemKey+'-id" onchange="selectItem(getValue(this),\''+itemKey+'\')"><option selected value="0">0</option></select></div></td>')
  }
  a.push('<td colspan="4"><div id="'+itemKey+'-form-error" class="error"/></td></tr>')
  for (var k in fields) {
    if (k.charAt(0) == '_') continue
    var f = fields[k]
    a.push('<tr><td colspan="4"><div id="'+itemKey+'-'+k+'-error" class="error"/></td></tr>')
    a.push('<tr><td class="key"><span class="EN">'+f.name.EN+'</span><span class="NL">'+f.name.NL+'</span></td><td class="price">'+(f.price ? '&euro; '+f.price.toFixed(2) : '')+'</td><td class="colon">:</td><td class="value">')
    if (f.type == 'text') a.push('<input id="'+itemKey+'-'+k+'" type="text" value=""/>')
    if (f.type == 'textarea') a.push('<textarea id="'+itemKey+'-'+k+'" rows="3" value=""></textarea>')
    if (f.type == 'date') a.push('<input id="'+itemKey+'-'+k+'" type="date" value=""/>')
    if (f.type == 'select') {
      a.push('<select id="'+itemKey+'-'+k+'"'+(complex ? 'onchange="updateForm(\''+itemKey+'\')"' : 'onchange="simpleChange(\''+itemKey+'\',\''+k+'\')"')+'>')
      var options = f.options()
      for (var n in options) {
        var o = options[n]
        var optionName = o.EN+(o.NL != o.EN ? ' / '+o.NL : '')
        a.push('<option value="'+n+'">'+optionName+'</option>')
      }
      a.push('</select>')
    }
    if (f.type == 'radio') {
      var options = f.options()
      var first = true
      for (var n in options) {
        var optionName = '<span class="EN">'+options[n].EN+'</span><span class="NL">'+options[n].NL+'</span>'
        a.push('<input '+(first ? 'id="'+itemKey+'-'+k+'" ' : '')+' name="'+itemKey+'-'+k+'" type="radio" value="'+n+'"/>'+optionName)
        first = false
      }
    }
    a.push('</td></tr>')
  }
  if (complex) {
    var editHtml = '<span class="EN">Add/edit this '+itemName.EN[0]+'</span><span class="NL">Wijzig/Voeg '+itemName.NL[0]+' toe</span>'
    var deleteHtml = '<span class="EN">Delete this '+itemName.EN[0]+'</span><span class="NL">Verwijder '+itemName.NL[0]+'</span>'
    a.push('<tr><td colspan="4"><button onclick="addItem(\''+itemKey+'\')">'+editHtml+'</button>&nbsp;<button onclick="deleteItem(\''+itemKey+'\')"/>'+deleteHtml+'</td></tr>')
  }
  a.push('</table>')
  getElem(itemKey+'-form').innerHTML = a.join('')
  if (complex) updateItems(itemKey);
  else updateValues(itemKey) 
}

/* callback functions */
function selectItem(id,itemKey) {
  var items = DATA[itemKey]
  var r = items[id]
  var fields = FORMS[itemKey]
  if (!r) { 
    r = {}; 
    for (var k in fields) { 
      if (k.charAt(0) == '_') continue
      r[k] = fields[k].default || ''
    }
  }
  var elem = getElem(''+itemKey+'-id')
  var options = elem.options
  for (var k in options) { if (options[k].value == id) elem.selectedIndex = k }
  for (var k in fields) {
    if (k.charAt(0) == '_') continue
    setValue(getElem(itemKey+'-'+k),r[k])
  }
}

function updateItems(itemKey) {
  var items = DATA[itemKey]
  var fields = FORMS[itemKey]
  var a = []
  a.push('<div class="list"><span class="EN">List of '+LANG[itemKey].EN[1]+'</span><span class="NL">Lijst met '+LANG[itemKey].NL[1]+'</span>:<table class="list">')
  for (var id in items) {
    var r = items[id]
    if (r) {
      a.push('<tr onclick="selectItem('+id+',\''+itemKey+'\')"><td>'+id+'</td>')
      for (var k in r) {
        var f = fields[k]
        var opts = (f && f.options && f.options()) || {}
        var v = opts[r[k]]
        v = v ? '<span class="NL">'+v.NL+'</span><span class="EN">'+v.EN+'</span>' : r[k]
        a.push('<td>'+v+'</td>')
      }
      a.push('</tr>')
    }
  }
  a.push('<tr onclick="selectItem('+next(items)+',\''+itemKey+'\')"><td colspan="100"><span class="EN">(next)</span><span class="NL">(volgende)</span></td></tr></tr>')
  a.push('</table></div>')
  getElem(''+itemKey+'-list').innerHTML = a.join('')
  a = []
  for (var id in items) {
    a.push('<option value="'+id+'">'+id+'</option>')
  }
  id = next(items)
  a.push('<option selected value="'+id+'">'+id+'</option>')
  getElem(''+itemKey+'-id').innerHTML = a.join('')
  selectItem(id,itemKey)
}

function updateValues(itemKey) {
  var values = DATA[itemKey]
  for (var k in values) {
    var elem = getElem(''+itemKey+'-'+k)
    setValue(elem,values[k])
  }
}

/* updates form values and options */
function updateForm(itemKey) {
  var fields = FORMS[itemKey]
  for (var k in fields) {
    if (k.charAt(0) == '_') continue
    var f = fields[k]

    var val = f.preset && f.preset(itemKey)
    var elem = getElem(itemKey+'-'+k)
    if (val) {
      setValue(elem,val)
      elem.disabled = true
    } else {
      elem.disabled = false
    }

    var options = (f.type == 'select') && f.options(itemKey)
    if (options) {
      setOptions(elem,f.type,options)
    }
  }
}

function updateForms(modifiedItem) {
  var skip = true
  for (var itemKey in FORMS) {
    if (itemKey == modifiedItem) skip = false
    if (!skip) {
      updateForm(itemKey)
    }
  }
}

function toggleError(id,msg) {
  if (msg) {
    FORM_ERROR = true
    var e = getElem(''+id+'-error'); e.innerHTML = msg; e.style.display = 'block'
  } else {
    var e = getElem(''+id+'-error'); e.innerHTML = msg; e.style.display = 'none'
  }
}

function simpleChange(itemKey,k) {
  var elem = getElem(itemKey+'-'+k)
  var val = getValue(elem)
  DATA[itemKey][k] = val
  setCookie('DATA',JSON.stringify(DATA))
  summarize()
}

function addItem(itemKey) {
  FORM_ERROR = false;
  var id = getElem(''+itemKey+'-id').value.trim()
  var fields = FORMS[itemKey]
  var values = {}
  for (var k in fields) {
    if (k.charAt(0) == '_') continue
    var f = fields[k]
    var val = getValue(getElem(''+itemKey+'-'+k),f.type)
    if (f.check) {
      if ((f.default !== undefined) && val === f.default) toggleError(itemKey+'-'+k,'') 
      else val = f.check(val,itemKey,k)
    }
    values[k] = val
  }
  if (!FORM_ERROR) {
    DATA[itemKey][id] = values
    setCookie('DATA',JSON.stringify(DATA))
    updateItems(itemKey)
    updateForms(itemKey)    
    summarize()
  }
}

function deleteItem(itemKey) {
  var id = getElem(''+itemKey+'-id').value.trim()
  DATA[itemKey][id] = null
  setCookie('DATA',JSON.stringify(DATA))
  updateItems(itemKey)
  updateForms(itemKey)    
  summarize()
}

function selectLanguage(on) {
  var styleSheet = document.styleSheets[0]
  var rules = styleSheet.cssRules;
  var remove = styleSheet.deleteRule || styleSheet.removeRule
  remove.apply(styleSheet,[rules[0]])
  remove.apply(styleSheet,[rules[1]])
  var insert = styleSheet.insertRule || styleSheet.addRule
  if (on == 'EN') {
    insert.apply(styleSheet,['span.NL { display: none }',0])
    insert.apply(styleSheet,['span.EN { display: inline }',0])
  } else {
    insert.apply(styleSheet,['span.NL { display: inline }',0])
    insert.apply(styleSheet,['span.EN {display: none }',0])
  }  
  setCookie('LANG',JSON.stringify(on))
}

function getPrice(itemKey,keys) {
  var values = DATA[itemKey]
  var fields = FORMS[itemKey]
  if (!keys) { keys = []; for (var k in values) keys.push(k) }
  var price = 0
  for (var i=0; i<keys.length; i++) {
    var k = keys[i]
    price += Number(values[k] || 0)*(fields[k].price || 0)
  }
  return price
}

function summaryItem() {
  var a = []
  a.push('<li>')
  for (var i=0; i<arguments.length; i++) {
    var fr = arguments[i]
    a.push(typeof(fr)=='object' ? '<span class="EN">'+fr.EN+'</span><span class="NL">'+fr.NL+'</span>' : fr)
  }
  a.push('</li>')
  return a.join('')
}

function summarize() {
  var a = []
  var amount = 0
  // form values to be submitted
  getElem('submit-comment').value = JSON.stringify(DATA)

  // CAMPING
  a.push('<b>Camping</b><ul>')
  var values = DATA['camping']
  var fields = FORMS['camping']
  // summary
  var price = getPrice('camping',['adultFri','childFri'])
  amount += price
  a.push(summaryItem( {NL:'Op vrijdag kampeer je met ',EN:'On Friday, you camp with '}, values.adultFri || 0, {NL:' volwassenen en ',EN:' adults and '}, values.childFri || 0, {NL:' kinderen. Dit kost &euro; ', EN:' children. This costs &euro; '}, price.toFixed(2)+'.' ))
  price = getPrice('camping',['adultSat','childSat'])
  amount += price
  a.push(summaryItem(
    {NL:'Op zaterdag kampeer je met ',EN:'On Saturday, you camp with '},
    values.adultSat || 0,
    {NL:' volwassenen en ',EN:' adults and '},
    values.childSat || 0,
    {NL:' kinderen. Dit kost &euro; ', EN:' children. This costs &euro; '},
    price.toFixed(2)+'.'
  ))
  // form values to be submitted
  for (var k in values) {
    var elem = getElem('submit-camping-'+k)
    if (elem) elem.value = (Number(values[k]) || '')
  }
  
  // MEALS
  a.push('</ul><b>Meals</b><ul>')
  values = DATA['meal']
  fields = FORMS['meal']
  // summary
  price = getPrice('meal',['mealPlan'])
  amount += price
  a.push(summaryItem(
    {EN:'You are ordering ',NL:'Je bestelt '},
    values.mealPlan || 0,
    {EN:' meal-plans (breakfast Sat/Sun, dinner Sat). This costs &euro; ',NL:' maaltijd-arrangementen (ontbijt za/zo, diner za). Dit kost &euro; '},
    price.toFixed(2)+'.'
  ))  
  price = getPrice('meal',['mealFri','breakfastSat','mealSat','breakfastSun'])
  amount += price
  a.push(summaryItem( 
    {EN:'In addition, you order ',NL:'Daarnaast bestel je '}, 
    values.mealFri || 0, 
    {EN:'x Friday dinner, ',NL:'x vrijdag maaltijd, '}, 
    values.breakfastSat || 0, 
    {EN:'x Saturday breakfast, ',NL:'x zaterdag ontbijt, '}, 
    values.mealSat || 0, 
    {EN:'x Saturday dinner and ',NL:'x zaterdag maaltijd en '}, 
    values.breakfastSun || 0, 
    {EN:'x Sunday breakfast. This costs &euro; ',NL:'x zondag ontbijt. Dit kost &euro; '}, 
    price+'.'
  ))
  // form values to be submitted
  for (var k in values) {
    var elem = getElem('submit-meal-'+k)
    if (elem) elem.value = (Number(values[k]) || '')
  }

  // RACES
  a.push('</ul><b>Races</b><ul>')
  /* compute days that riders are racing */
  var races = [[],[],[]]
  for (var itemKey in FORMS) {
    var fields = FORMS[itemKey]
    if (fields._day) races[fields._day].push(itemKey)
  }

  var riderRaces = {}
  for (var d=1; d<=2; d++) {
    var rd = races[d]
    for (var i=0; i<rd.length; i++) {
      var itemKey = rd[i]
      var br = DATA[itemKey] // bike+rider
      for (var k in br) {
        if (br[k]) {        
          var r = br[k].rider
          if (!riderRaces[r]) riderRaces[r] = [[],[],[]]
          riderRaces[r][d].push(itemKey)
        }
      }
    }
  }
  var numSatOnly = 0
  var numSunOnly = 0
  var numTwoDays = 0  
  for (var r in riderRaces) {
    var sat = riderRaces[r][1]
    var sun = riderRaces[r][2]
    var numSat = sat.length
    var numSun = sun.length
    sat = numSat ? '"'+riderRaces[r][1].join('","')+'"' : ''
    sun = numSun ? '"'+riderRaces[r][2].join('","')+'"' : ''
    price = 0
    if (numSat && numSun) { numTwoDays++; price = HIDDEN.race.twoDays.price }
    else if (numSat) { numSatOnly++; price = HIDDEN.race.oneDay.price }
    else if (numSun) { numSunOnly++; price = HIDDEN.race.oneDay.price }
    amount += price
    a.push(summaryItem(
      {EN:'Rider ',NL:'Rijder '},
      r,
      {EN:' participates in '+(sat || 'nothing'),NL:' doet mee aan '+(sat || 'niets')},
      {EN:' on Saturday and '+(sun || 'nothing'),NL:' op zaterdag en '+(sun || 'niets')},
      {EN:' on Sunday. This costs &euro; ',NL:' op Zondag. Dit kost &euro; '},
      price+'.'
    ))
  }  
  a.push('</ul><b><span class="EN">Total</span><span class="NL">Totaal</span></b><ul>')
  a.push(summaryItem({EN:'The total amount of your order is &euro; ',NL:'Het totaalbedrag van uw bestelling is &euro; '},amount+'.'))
  // form values to be submitted
  var elem = getElem('submit-race-satSun')
  if (elem) elem.value = (numTwoDays || '')
  var elem = getElem('submit-race-sat')
  if (elem) elem.value = (numSatOnly || '')
  var elem = getElem('submit-race-sun')
  if (elem) elem.value = (numSunOnly || '')

  getElem('summary').innerHTML = a.join('')
}

function prefillUser(data) {
  if (!DATA.rider || !DATA.rider.length) {
    getElem('rider-email').value = data.email
    getElem('rider-nickname').value = data.username
    getElem('rider-ligfietsnet').value = data.id
  }
}

function onload() {
  $.ajax({
    url: 'https://www.ligfiets.net/userinfo',
    method: 'GET',
    xhrFields: {
      withCredentials: true
    }
  }).done(function(data) {
    if (data && data.id) {
      initData(); for (var k in FORMS) initForm(k); initLanguage()
      prefillUser(data)
    } else {
      getElem('forms').innerHTML = '<a href="https://www.ligfiets.net/user/login"><span class="EN">Login to your ligfiets.net account</span><span class="NL">Log eerst in bij ligfiets.net</span></a><span class="EN"> first, or </span><span class="NL">, of </span><a href="https://www.ligfiets.net/user/register"><span class="EN">create an account</span><span class="NL">maak een account aan</span></a>, <span class="EN">then refresh this page</span><span class="NL">ververs daarna deze pagina</span>.'
    }
  }).fail(function(msg) {
    console.log('Failure to query ligfiets.net')
    initData(); for (var k in FORMS) initForm(k); initLanguage()
  })
}
</script>
</head>
<body onload="onload()">
<!-- start page--><div id="page">
<img src="cvheader2017blauw.png" style="width: 1146px; height:150px"/>
<!-- start main--><div id="main">
<p>Choose your language / Kies uw taal</p>
<div class="lang"><input type="button" value="ENGLISH" onclick="selectLanguage('EN')">&nbsp;<input type="button" value="NEDERLANDS" onclick="selectLanguage('NL')"></div>
<p><span class="EN">Welcome to the <b>CycleVision registration module</b>. It allows you to
register multiple riders with multiple bikes.<br/>If you are not participating in any races, you can also use the <a href="http://www.ligfiets.net/event/3771/cycle-vision.html">simple form at Ligfiets.net</a>.</span><span class="NL">Welkom bij de <b>CycleVision registratie module</b>. Hiermee kun je meerdere rijders met verschillende fietsen inschrijven voor de races.<br/>Als je geen races rijdt kun je ook het <a href="http://www.ligfiets.net/event/3771/cycle-vision.html">simpele Ligfiets.net formulier</a> gebruiken.</span>
<!-- start forms--><div id="forms"><span class="EN">Make sure you are logged in to your <a href="https://www.ligfiets.net/user/login" "target="_blank">Ligfiets.net account</a> before you continue.
<br/>Fill out the forms below, 
click [Done] at the bottom, and you will be taken back to the Ligfiets.net
registration page where you can confirm and pay.</span><span class="NL">Zorg dat je ingelogd bent op <a href="https://www.ligfiets.net/user/login" "target="_blank">Ligfiets.net</a> voordat je verder gaat.
<br/>Vul de formulieren hieronder in, druk daarna helemaal onderaan op [Gereed], en je wordt teruggeleid naar de Ligfiets.net inschrijfpagina waar je kunt bevestigen en betalen.</span>
</p>
<h2>Camping</h2>

<div id="camping-form">
</div>

<h2><span class="EN">Meals</span><span class="NL">Maaltijden</span></h2>

<div id="meal-form">
</div>

<h2><span class="EN">Races</span><span class="NL">Wedstrijden</span></h2>

<h3>Team</h3>
<span class="EN">Enter the details for all riders that you are registering, including
yourself.</span><span class="NL">Vul voor iedere rijder die je aanmeldt de gegevens in, ook voor jezelf.</span>
<div id="rider-list">
</div>
<div id="rider-form">
</div>

<h3><span class="EN">Bikes</span><span class="NL">Fietsen</span></h3>
<span class="EN">Enter the details for all bikes that you/your team will use.</span><span class="NL">Maak hier een lijst met alle fietsen die jij of je team gaat inzetten.</span>
<div id="bike-list">
</div>
<div id="bike-form">
</div>

<h3><span class="EN">Race disciplines</span><span class="NL">Wedstrijdonderdelen</span></h3>
<span class="EN">Enter for each race which rider+bike combinations will participate. In case of a tandem, also enter the stoker+bike combination.</span><span class="NL">Vul voor elke race de deelnemende rijder+fiets combinaties in. Voeg in geval van een tandem ook de stoker+fiets combinatie toe.</span>
<h3><span class="EN">1 hour time trial (Saturday)</span><span class="NL">1 uurs tijdrit (Zaterdag 9:00 buiten)</span></h3>
<div id="onehour-list">
</div>
<div id="onehour-form">
</div>

<h3><span class="EN">Fastest lap flying start (200m) indoor (Saturday)</span><span class="NL">Snelste vliegende start (200m) velodrome (Zaterdag 13:00 binnen)</span></h3>
<div id="indoor1lap-list">
</div>
<div id="indoor1lap-form">
</div>

<h3><span class="EN">Criterium for single-track bikes (Saturday 19:00 outdoor)</span><span class="NL">Criterium voor tweewielers (Zaterdag 19:00 buiten)</span></h3>
<div id="singletrack-list">
</div>
<div id="singletrack-form">
</div>

<h3><span class="EN">Criterium for multi-track bikes (Saturday 21:00 outdoor)</span><span class="NL">Criterium voor drie/vierwielers (Zaterdag  21:00 buiten)</span></h3>
<div id="multitrack-list">
</div>
<div id="multitrack-form">
</div>

<h3><span class="EN">Fastest lap outdoor (Sunday 20:30 outdoor)</span><span class="NL">Snelste ronde buiten (Zondag 20:30 buiten)</span></h3>
<div id="outdoor1lap-list">
</div>
<div id="outdoor1lap-form">
</div>

<h3><span class="EN">Combined 3 and 6 hour race (Sunday)</span><span class="NL">Gecombineerde 3/6 uurs race (Zondag 10:00 buiten)</span></h3>
<span class="EN">Note: the 6 hour race will only proceed with 10 or more participants.</span><span class="NL">Let op: de 6 uursrace gaat alleen door als er tenmminste 10 deelnemers zijn.</span>
<div id="threehour-list">
</div>
<div id="threehour-form">
</div>

<!--h2><span class="EN">Confirm and pay</span><span class="NL">Bevestig en betaal</span></h2-->

<h2><span class="EN">Order summary and payment</span><span class="NL">Besteloverzicht en betaling</span></h2>
<div id="summary"></div>

<form action="https://www.ligfiets.net/create/event/registration?id=3771" method="post">
  <input type="hidden" id="submit-camping-adultFri" name="stuffs[stuff_630]"/>
  <input type="hidden" id="submit-camping-childFri" name="stuffs[stuff_631]"/>
  <input type="hidden" id="submit-camping-adultSat" name="stuffs[stuff_632]"/>
  <input type="hidden" id="submit-camping-childSat" name="stuffs[stuff_633]"/>
  <input type="hidden" id="submit-meal-mealFri" name="stuffs[stuff_634]"/>
  <input type="hidden" id="submit-meal-mealPlan" name="stuffs[stuff_635]"/>
  <input type="hidden" id="submit-meal-breakfastSat" name="stuffs[stuff_636]"/>
  <input type="hidden" id="submit-meal-mealSat" name="stuffs[stuff_637]"/>
  <input type="hidden" id="submit-meal-breakfastSun" name="stuffs[stuff_638]"/>
  <input type="hidden" id="submit-race-satSun" name="stuffs[stuff_639]"/>
  <input type="hidden" id="submit-race-sat" name="stuffs[stuff_640]"/>
  <input type="hidden" id="submit-race-sun" name="stuffs[stuff_641]"/>
  <input type="hidden" id="submit-comment" name="comment"/>
  <span class="EN">Make sure you are logged in to your <a href="https://www.ligfiets.net/user/login" "target="_blank">Ligfiets.net account</a> before you continue.</span><span class="NL">Zorg dat je ingelogd bent op <a href="https://www.ligfiets.net/user/login" "target="_blank">Ligfiets.net</a> voordat je verder gaat.</span>
  <p><input type="submit" id="submit" value="Go to payment / Ga naar betalen"/></p>
</form>
</p>

<!-- end forms--></div>
<!-- end main--></div>
<!-- end page--></div>
</body></html>